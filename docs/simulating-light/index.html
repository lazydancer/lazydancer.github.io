<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="favicon.ico" type="image/x-icon"/>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>

  <title>James Pucula - Simulating Light</title>

  <style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');</style>
  <script>
    (function() {
      try {
        var stored = localStorage.getItem('theme');
        var mediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
        var prefersDark = mediaQuery ? mediaQuery.matches : false;
        var theme = stored || (prefersDark ? 'dark' : 'light');
        document.documentElement.dataset.theme = theme;
      } catch (err) {
        document.documentElement.dataset.theme = 'light';
      }
    })();
  </script>
  <link rel = "stylesheet" type="text/css" href="/style.css"/>

</head>
<body>
  <header>
        <a href="/">
  <img width="64" height="64" src="/finch_128.png"></a>
    <button id="theme-toggle" class="theme-toggle" type="button">Dark mode</button>
  </header>

  <main>
<h1>Simulating Light</h1>
<div class="project-links">
    <a class="github-icon" href="https://github.com/lazydancer/rust-raytracer" aria-label="View Simulating Light on GitHub">
        <svg aria-hidden="true" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38C13.71 14.53 16 11.54 16 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
        <span>GitHub</span>
    </a>
</div>

<p>As a learning exercise, I recently completed Peter Shirley's "Ray Tracing in One Weekend." I am always impressed by the power of computer graphics and how much can be achieved with just a few lines of code, especially when performance is not a primary concern. In this post, I hope to share some of the key takeaways and insights I gained from this experience, as well as provide an overview of my journey in creating a ray tracer.</p>
<img src="Untitled.png" alt="Untitled.png">
<p>I found the project to be an ideal balance of complexity and flexibility. It is big enough to require breaking things apart and making design choices, while still being small enough to keep the program manageable. Additionally, I found the output of the ray tracer to be incredibly satisfying, as it is a great visualization of the code and the results of collision detection and matrix mapping</p>
<p>This is the third ray tracer I have created. The first one I wrote was in Python, but it was too slow. The second was in Python with Numpy, which was faster, but the linear maps were confusing. The third one I wrote in Rust. Through this journey, I have learned a lot and I hope that by sharing my experience, it will inspire others to try their hand at creating their own light simulator</p>
<h2 id="python">Python</h2>
<p>Python is an awesome language I use everyday in a variety of tasks and most of the time the speed of the language is not the bottleneck. Python became the bottleneck even after optimizing as much as I could without reverting to C calls. I knew I was fighting an uphill battle and without large algorithm improvements I couldn&#39;t squeeze any more out of it without changing the base datatype. </p>
<h2 id="numpy">Numpy</h2>
<p>Numpy is a Python library which stores and operates on highly optimized multi-dimensional arrays. This combined with linear functions makes it very fast. Using the CPU&#39;s linear accelerators such as BLAS and LAPACK. In the future I wish to try again with GPU, there doesn&#39;t seem to be much support outside of the CUDA API.</p>
<p>Writing linear maps was a difficult but good learning experience. Some things I learned but might only apply to this narrow case</p>
<ul>
<li>Index masks are faster than boolean masks</li>
<li>Vectorization is key but can make things confusing. This was the first time I heard of the Einstein summation notation &quot;np.einsum(&#39;ij, ij-&gt;i&#39;, m, directions)&quot;</li>
<li>32-bit float was the fastest, 64-bit float was slower, 16-bit float slowest</li>
</ul>
<p>And the results looked okay:</p>
<img src="Untitled%201.png" alt="Untitled%201.png">
<h2 id="rust">Rust</h2>
<p>I wanted to rewrite it in a faster language. I have started working on it in Rust. </p>
<p>Taking 5,000 rays per pixel I created this image in 12 minutes. I also learned a lot about Rust structure and writing it effectively. Here is the build up looks like</p>
<img src="Untitled%202.png" alt="Untitled%202.png">
<p>219 ms - 1 ray per pixel - 275,800 rays</p>
<img src="Untitled%203.png" alt="Untitled%203.png">
<p>1 s - 7 rays per pixel - 1,930,600 rays</p>
<img src="Untitled%204.png" alt="Untitled%204.png">
<p>10 s - 85 rays per pixel - 23,443,000 rays</p>
<img src="Untitled%205.png" alt="Untitled%205.png">
<p>116s - 1000 rays per pixel - 275,800,000 rays</p>
<img src="Untitled.png" alt="Untitled.png">
<p>1124s (18.7 mins) - 10,000 rays per pixel - 2,758,000,000 rays</p>
<p>Writing these ray tracers made me realize why ray tracing isn&#39;t the default compared to rasterized rendering even though it could look better and easier to program.  There is such a large speed boost when using rasterized rendering that you can have more complex scenes. Computers are fast for doing numerical operations but also the world is full of unfathomably large numbers too. A 100W light bulb would output 10^20 photons (assume 100% efficient, 600 nm light). The latest graphics card can achieve around 10^13 floating operations per second, which is crazy fast, but still 7 orders of magnitude off for each photon to have 1 operation per second. There are many things that can be done to speed it up and we don't need to simulate all of them.  </p>
<p>I'm excited to continue learning more about ray tracers and things like:</p>
<ul>
<li>GPU acceleration</li>
<li>Neural network denoising</li>
<li>Optimized collision detection (ex. AABB)</li>
<li>Improved sampling methods (ex. PDFs)</li>
</ul>
<p><a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html">https://raytracing.github.io/books/RayTracingInOneWeekend.html</a></p>
<p><a href="https://www.scratchapixel.com/">https://www.scratchapixel.com/</a></p>
<p><a href="https://bheisler.github.io/post/writing-raytracer-in-rust-part-1/">https://bheisler.github.io/post/writing-raytracer-in-rust-part-1/</a></p>
<p><a href="https://www.shadertoy.com/">https://www.shadertoy.com/</a></p>
  </main>
  <script>
    (function() {
      var toggle = document.getElementById('theme-toggle');
      if (!toggle) {
        return;
      }

      var root = document.documentElement;

      function currentTheme() {
        return root.dataset.theme === 'dark' ? 'dark' : 'light';
      }

      function updateLabel(theme) {
        var next = theme === 'dark' ? 'light' : 'dark';
        toggle.textContent = next.charAt(0).toUpperCase() + next.slice(1) + ' mode';
        toggle.setAttribute('aria-label', 'Activate ' + next + ' mode');
        toggle.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
      }

      updateLabel(currentTheme());

      toggle.addEventListener('click', function() {
        var next = currentTheme() === 'dark' ? 'light' : 'dark';
        root.dataset.theme = next;
        try {
          localStorage.setItem('theme', next);
        } catch (err) {
          /* localStorage might be unavailable; ignore */
        }
        updateLabel(next);
      });
    })();
  </script>
  </body>
</html>
